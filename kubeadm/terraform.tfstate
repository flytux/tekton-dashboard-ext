{"version":4,"terraform_version":"1.8.8","serial":109,"lineage":"bc00ae00-81ba-efe6-11ec-d336f62f98c2","outputs":{},"resources":[{"mode":"managed","type":"local_file","name":"master_init","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster \nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nPATH=/usr/local/bin:$PATH\nkubeadm init --pod-network-cidr=10.244.0.0/16 --upload-certs --control-plane-endpoint=k8smaster:6443 --kubernetes-version v1.31.0 | \\\nsed -e '/kubeadm join/,/--certificate-key/!d' | head -n 3 \u003e join_cmd\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\n#helm repo add cilium https://helm.cilium.io/\nhelm upgrade -i cilium kubeadm/kubernetes/charts/cilium-1.16.5.tgz -f $HOME/kubeadm/cilium/values.yaml -n kube-system\n\n\n#helm repo add traefik https://helm.traefik.io/traefik --force-update\nhelm upgrade -i traefik kubeadm/kubernetes/charts/traefik-33.2.1.tgz -n kube-system --set ingressRoute.dashboard.enabled=true\n\nsleep 30\n\nkubectl apply -f $HOME/kubeadm/cilium/announce-ip-pool.yaml\n","content_base64":null,"content_base64sha256":"YmOg77fZcReJSe5iCWMFIuSJstBUXv5s3N4+iO1uLwY=","content_base64sha512":"+D8SnmWWmsRf+PfpJkbjCmAEeM1FDfV8+j4rnS+jfuXD5niHa+Bp/gZAk6sz5XKCh/+lpgAl/Lw1Hoe4cn+Tjw==","content_md5":"cc8e9397fc5321b691527dcb45ba3cdf","content_sha1":"e45c93abba17f1d4421b5fe0c219e24f26b34ce9","content_sha256":"6263a0efb7d971178949ee6209630522e489b2d0545efe6cdcde3e88ed6e2f06","content_sha512":"f83f129e65969ac45ff8f7e92646e30a600478cd450df57cfa3e2b9d2fa37ee5c3e678876be069fe064093ab33e5728287ffa5a60025fcbc351e87b8727f938f","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-init.sh","id":"e45c93abba17f1d4421b5fe0c219e24f26b34ce9","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"master_member","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\nchmod 400 $HOME/.ssh/id_rsa.key\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.38 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.38 -- cat join_cmd | sh -\n\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\n","content_base64":null,"content_base64sha256":"S29pJ1/QshGqRsM6gIeolwUDkgZOD6TsGkWH5cg6H7k=","content_base64sha512":"467vshVS4OmqhaeD99Quw55EDHMphJEGwQKAdcAPGRWIMdiFkqzUsNpz56oiwzh4FIYM1vu+eBUVnPor0cQw5g==","content_md5":"9e6c83751f2cb8fea1f07d529fbe48ce","content_sha1":"5f72573b31bfb0b55b2b60ae7d07402428d91a34","content_sha256":"4b6f69275fd0b211aa46c33a8087a897050392064e0fa4ec1a4587e5c83a1fb9","content_sha512":"e3aeefb21552e0e9aa85a783f7d42ec39e440c7329849106c1028075c00f19158831d88592acd4b0da73e7aa22c3387814860cd6fbbe7815159cfa2bd1c430e6","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-member.sh","id":"5f72573b31bfb0b55b2b60ae7d07402428d91a34","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"prepare_kubeadm","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"#!/bin/sh\n\nset -x\n#Add k8smaster IP\necho \"192.168.122.38    k8smaster\" \u003e\u003e /etc/hosts\n\n# Swap off\nswapoff -a                 \nsed -e '/swap/ s/^#*/#/' -i /etc/fstab  \n\nif [ ! -z \"$(cat /etc/*release | grep -i ubuntu)\" ]; \nthen\n  echo \"Ubuntu: Install containerd, socat, conntrack\"\n  dpkg -i kubeadm/packages/*.deb\nelse\n  echo \"Rocky: Install containerd, socat, conntracl\"\n  setenforce 0\n  sed -i --follow-symlinks 's/SELINUX=.*/SELINUX=disabled/g' /etc/sysconfig/selinux\n  #dnf install -y dnf-utils\n  #dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n  #dnf install -y containerd.io socat conntrack iproute-tc iptables-ebtables iptables\n  rpm -Uvh kubeadm/packages/*.rpm --force\nfi\n\n# Config containerd\nmkdir -p /etc/containerd\ncp kubeadm/packages/config.toml /etc/containerd/\n\nmkdir -p /etc/nerdctl\ncp kubeadm/kubernetes/config/nerdctl.toml /etc/nerdctl/nerdctl.toml\n\nsystemctl enable containerd --now\n\n# Copy network binaries\ncp kubeadm/kubernetes/bin/* /usr/local/bin\n\n# Copy kubernetes binaries\ncp kubeadm/kubernetes/bin/v1.31.0/* /usr/local/bin\n\nchmod +x /usr/local/bin/*\ncp -R kubeadm/cni /opt\nchmod +x /opt/cni/bin/*\n\n# Load kubeadm container images\n#nerdctl load -i kubeadm/images/kubeadm.tar\n\n# Configure and start kubelet\ncp kubeadm/kubernetes/config/kubelet.service /etc/systemd/system\nmkdir -p /etc/systemd/system/kubelet.service.d\n\\cp -f kubeadm/kubernetes/config/kubelet.service.d/10-kubeadm.conf /etc/systemd/system/kubelet.service.d\n\nsystemctl daemon-reload\nsystemctl enable kubelet --now\n","content_base64":null,"content_base64sha256":"Pfj37bEPfPYJDtCCRpggMuBPtA5Wsqdml3fmZY/doI4=","content_base64sha512":"PZ+azogZnzaLdt93muTGz9Jc1B7XW4EjFcxELHrIFSxzO0Uj2OpgUC/jPTflQFjYJIH+45gTnZZ7+oxrXUUpGg==","content_md5":"13a29171750977d215f56e70dff58296","content_sha1":"2ced1378d447d4ba3dda12ad7276d945f919f176","content_sha256":"3df8f7edb10f7cf6090ed08246982032e04fb40e56b2a7669777e6658fdda08e","content_sha512":"3d9f9ace88199f368b76df779ae4c6cfd25cd41ed75b812315cc442c7ac8152c733b4523d8ea60502fe33d37e54058d82481fee398139d967bfa8c6b5d45291a","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/prepare-kubeadm.sh","id":"2ced1378d447d4ba3dda12ad7276d945f919f176","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]]}]},{"mode":"managed","type":"local_file","name":"worker","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init node\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nchmod 400 $HOME/.ssh/id_rsa.key\n\n# Rocky linux \n#dnf install -y socat conntrack\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.38 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.38 -- kubeadm token create --print-join-command | sh -\n\nmkdir -p $HOME/.kube\nssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.38 -- cat /etc/kubernetes/admin.conf \u003e $HOME/.kube/config\nsed -i \"s/127\\.0\\.0\\.1/{master_ip}/g\" $HOME/.kube/config\n","content_base64":null,"content_base64sha256":"MloJAqgX/yKtKRNwiN9jqEwhSnqY7PZr8fOi+CcOoj8=","content_base64sha512":"yTGs5jpwUIGraXXF9yKyey3QGRdJAQqsykB8IcjSG89ToUjjkJGMibrd69g7Mj8UxubYfqXeaR57dYVayL+FUQ==","content_md5":"d2fd13f970fbbc735ec26756528d3d5f","content_sha1":"bc292c63c24ae38e56fb77f743f77ce20b394fe4","content_sha256":"325a0902a817ff22ad29137088df63a84c214a7a98ecf66bf1f3a2f8270ea23f","content_sha512":"c931ace63a705081ab6975c5f722b27b2dd0191749010aacca407c21c8d21bcf53a148e390918c89baddebd83b323f14c6e6d87ea5de691e7b75855ac8bf8551","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/worker.sh","id":"bc292c63c24ae38e56fb77f743f77ce20b394fe4","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"terraform_data","name":"add_worker","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"w1","schema_version":0,"attributes":{"id":"390339c9-cf59-fcda-2f0d-02ac6a296d58","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker","terraform_data.copy_installer","terraform_data.init_master"]}]},{"mode":"managed","type":"terraform_data","name":"copy_installer","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"m1","schema_version":0,"attributes":{"id":"abcd648b-1a54-c6fc-a7f3-d1be0e470c2e","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]},{"index_key":"w1","schema_version":0,"attributes":{"id":"629e8db6-bf33-e4ae-d758-2b91e65b6089","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]}]},{"mode":"managed","type":"terraform_data","name":"init_master","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"m1","schema_version":0,"attributes":{"id":"875af99b-b0b4-85ea-f838-fc3a25e8b1a1","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker","terraform_data.copy_installer"]}]}],"check_results":null}

{"version":4,"terraform_version":"1.8.8","serial":25,"lineage":"bc00ae00-81ba-efe6-11ec-d336f62f98c2","outputs":{},"resources":[{"mode":"managed","type":"local_file","name":"master_init","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster \nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nPATH=/usr/local/bin:$PATH\nkubeadm init --pod-network-cidr=10.244.0.0/16 --upload-certs --control-plane-endpoint=k8smaster:6443 --kubernetes-version v1.30.4 | \\\nsed -e '/kubeadm join/,/--certificate-key/!d' | head -n 3 \u003e join_cmd\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\nhelm repo add cilium https://helm.cilium.io/\nhelm upgrade -i cilium cilium/cilium --version 1.15.8 -f $HOME/kubeadm/cilium/values.yaml -n kube-system\n\n\nhelm repo add traefik https://helm.traefik.io/traefik --force-update\nhelm upgrade -i traefik traefik/traefik --version 27.0.2 -n kube-system --set ingressRoute.dashboard.enabled=true\n\nsleep 30\n\nkubectl apply -f $HOME/kubeadm/cilium/announce-ip-pool.yaml\n","content_base64":null,"content_base64sha256":"YD9stzVcGkAPk6JxplnyAyg/MespZ5dMRMN6MJoR90A=","content_base64sha512":"glvdkhAu5fCWiD1DTdjmvg43398elLHCGo8+9geTtqePm6KX5kfJbF8uH3KcnWu73k0ZUD6vJXGFAbRMuZNhww==","content_md5":"a6bdf1a5f4753b2f5c732d0d6bca135a","content_sha1":"d66f4c2dc8ab70daed595a3d58c71f99da49edeb","content_sha256":"603f6cb7355c1a400f93a271a659f203283f31eb2967974c44c37a309a11f740","content_sha512":"825bdd92102ee5f096883d434dd8e6be0e37dfdf1e94b1c21a8f3ef60793b6a78f9ba297e647c96c5f2e1f729c9d6bbbde4d19503eaf25718501b44cb99361c3","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-init.sh","id":"d66f4c2dc8ab70daed595a3d58c71f99da49edeb","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"master_member","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\nchmod 400 $HOME/.ssh/id_rsa.key\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | sh -\n\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\n","content_base64":null,"content_base64sha256":"4ylN2MhIESzoICi90+We8yLJNGcCj2cN2XDNZTjjHjk=","content_base64sha512":"f0RgGIVz+nIuqaDVRbH0+bzsiFx/leMpY0Mer3jJXCSe00+dZcfgVUbjAoVdYtfLtYlvAOLCHYXCYBUE4MTkmA==","content_md5":"480b45cc8198c786004989e615ee9f56","content_sha1":"0470bf31d051ba14c247761e56d9fe6bb6f166c6","content_sha256":"e3294dd8c848112ce82028bdd3e59ef322c93467028f670dd970cd6538e31e39","content_sha512":"7f4460188573fa722ea9a0d545b1f4f9bcec885c7f95e32963431eaf78c95c249ed34f9d65c7e05546e302855d62d7cbb5896f00e2c21d85c2601504e0c4e498","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-member.sh","id":"0470bf31d051ba14c247761e56d9fe6bb6f166c6","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"prepare_kubeadm","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"#!/bin/sh\n\n# Rocky\n# Disble SELINUX \n# setenforce 0\n# sed -i --follow-symlinks 's/SELINUX=.*/SELINUX=disabled/g' /etc/sysconfig/selinux\n# #\n# dnf install -y dnf-utils\n# dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n# dnf install -y containerd.io socat conntrack iproute-tc iptables-ebtables iptables\n\n# Ubuntu fix using variables\n\nset -x\n#Add k8smaster IP\necho \"192.168.122.11    k8smaster\" \u003e\u003e /etc/hosts\n\n# Swap off\nswapoff -a                 \nsed -e '/swap/ s/^#*/#/' -i /etc/fstab  \n\necho \"Install containerd\"\ndpkg -i kubeadm/packages/containerd.io_1.6.33-1_amd64.deb\n\n\n# Config containerd\nmkdir -p /etc/containerd\ncp kubeadm/packages/config.toml /etc/containerd/\n\nmkdir -p /etc/nerdctl\ncp kubeadm/kubernetes/config/nerdctl.toml /etc/nerdctl/nerdctl.toml\n\nsystemctl restart containerd\n\n# Copy kubeadm and network binaries\ncp kubeadm/kubernetes/bin/* /usr/local/bin\nchmod +x /usr/local/bin/*\ncp -R kubeadm/cni /opt\nchmod +x /opt/cni/bin/*\n\n# Load kubeadm container images\n#nerdctl load -i kubeadm/images/kubeadm.tar\n\n# Configure and start kubelet\ncp kubeadm/kubernetes/config/kubelet.service /etc/systemd/system\nmkdir -p /etc/systemd/system/kubelet.service.d\n\\cp -f kubeadm/kubernetes/config/kubelet.service.d/10-kubeadm.conf /etc/systemd/system/kubelet.service.d\n\nsystemctl daemon-reload\nsystemctl enable kubelet --now\n","content_base64":null,"content_base64sha256":"SN4EU5+rN2nyoaFDa52cmwa1DlX/ON/Bo8cbeRhNc00=","content_base64sha512":"ktPeEFJiEJfimbQDScq1uHInj1Zz7a642Av2ndCdXcJ/t80xfzbxE2S4pyfpYS3STnIsKxGBvtmDUonKY8fUtQ==","content_md5":"25a91de5bf175288f729f793f0b9708a","content_sha1":"fc7c7f1d3f4c048198d9ce0322eae1052a608f9f","content_sha256":"48de04539fab3769f2a1a1436b9d9c9b06b50e55ff38dfc1a3c71b79184d734d","content_sha512":"92d3de1052621097e299b40349cab5b872278f5673edaeb8d80bf69dd09d5dc27fb7cd317f36f11364b8a727e9612dd24e722c2b1181bed9835289ca63c7d4b5","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/prepare-kubeadm.sh","id":"fc7c7f1d3f4c048198d9ce0322eae1052a608f9f","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]]}]},{"mode":"managed","type":"local_file","name":"worker","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init node\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nchmod 400 $HOME/.ssh/id_rsa.key\n\ndnf install -y socat conntrack\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- kubeadm token create --print-join-command | sh -\n\nmkdir -p $HOME/.kube\nssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat /etc/kubernetes/admin.conf \u003e $HOME/.kube/config\nsed -i \"s/127\\.0\\.0\\.1/{master_ip}/g\" $HOME/.kube/config\n","content_base64":null,"content_base64sha256":"RiZb6qqNM0SXwOAqIeoB4UTbp9Z6TJAjqEzwUI787UY=","content_base64sha512":"ABm45shXzdy9bafSp5qSuXg8WHIuVrxw4rZuyZn7IcT0A7FRW9buBObzvEosnOe6e1uZ/BnHGpmDfBeVaKhUhg==","content_md5":"aeede8f787f3e18aec7ed60472301038","content_sha1":"10dee4972c07cade4f23936aa39ac519db123346","content_sha256":"46265beaaa8d334497c0e02a21ea01e144dba7d67a4c9023a84cf0508efced46","content_sha512":"0019b8e6c857cddcbd6da7d2a79a92b9783c58722e56bc70e2b66ec999fb21c4f403b1515bd6ee04e6f3bc4a2c9ce7ba7b5b99fc19c71a99837c179568a85486","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/worker.sh","id":"10dee4972c07cade4f23936aa39ac519db123346","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"terraform_data","name":"add_worker","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"node-02","schema_version":0,"attributes":{"id":"e17ef077-5903-5338-e6a0-288e9903db14","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker","terraform_data.copy_installer","terraform_data.init_master"]}]},{"mode":"managed","type":"terraform_data","name":"copy_installer","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"node-01","schema_version":0,"attributes":{"id":"b2926352-f622-d0e5-b122-715b51a8a67e","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]},{"index_key":"node-02","schema_version":0,"attributes":{"id":"527f7cbb-15c0-8457-574c-d27f57b2eefd","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]}]}],"check_results":null}

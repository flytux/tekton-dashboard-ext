{"version":4,"terraform_version":"1.8.8","serial":88,"lineage":"bc00ae00-81ba-efe6-11ec-d336f62f98c2","outputs":{},"resources":[{"mode":"managed","type":"local_file","name":"master_init","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster \nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nPATH=/usr/local/bin:$PATH\nkubeadm init --pod-network-cidr=10.244.0.0/16 --upload-certs --control-plane-endpoint=k8smaster:6443 --kubernetes-version v1.31.0 | \\\nsed -e '/kubeadm join/,/--certificate-key/!d' | head -n 3 \u003e join_cmd\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\n#helm repo add cilium https://helm.cilium.io/\nhelm upgrade -i cilium kubeadm/kubernetes/charts/cilium-1.16.5.tgz -f $HOME/kubeadm/cilium/values.yaml -n kube-system\n\n\n#helm repo add traefik https://helm.traefik.io/traefik --force-update\nhelm upgrade -i traefik kubeadm/kubernetes/charts/traefik-33.2.1.tgz -n kube-system --set ingressRoute.dashboard.enabled=true\n\nsleep 30\n\nkubectl apply -f $HOME/kubeadm/cilium/announce-ip-pool.yaml\n","content_base64":null,"content_base64sha256":"YmOg77fZcReJSe5iCWMFIuSJstBUXv5s3N4+iO1uLwY=","content_base64sha512":"+D8SnmWWmsRf+PfpJkbjCmAEeM1FDfV8+j4rnS+jfuXD5niHa+Bp/gZAk6sz5XKCh/+lpgAl/Lw1Hoe4cn+Tjw==","content_md5":"cc8e9397fc5321b691527dcb45ba3cdf","content_sha1":"e45c93abba17f1d4421b5fe0c219e24f26b34ce9","content_sha256":"6263a0efb7d971178949ee6209630522e489b2d0545efe6cdcde3e88ed6e2f06","content_sha512":"f83f129e65969ac45ff8f7e92646e30a600478cd450df57cfa3e2b9d2fa37ee5c3e678876be069fe064093ab33e5728287ffa5a60025fcbc351e87b8727f938f","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-init.sh","id":"e45c93abba17f1d4421b5fe0c219e24f26b34ce9","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"master_member","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init cluster\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\nchmod 400 $HOME/.ssh/id_rsa.key\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | sh -\n\n# 02 copy kubeconfig\nmkdir -p $HOME/.kube\ncp -ru /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\n# 03 install cni\nkubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane:NoSchedule-\n\n","content_base64":null,"content_base64sha256":"4ylN2MhIESzoICi90+We8yLJNGcCj2cN2XDNZTjjHjk=","content_base64sha512":"f0RgGIVz+nIuqaDVRbH0+bzsiFx/leMpY0Mer3jJXCSe00+dZcfgVUbjAoVdYtfLtYlvAOLCHYXCYBUE4MTkmA==","content_md5":"480b45cc8198c786004989e615ee9f56","content_sha1":"0470bf31d051ba14c247761e56d9fe6bb6f166c6","content_sha256":"e3294dd8c848112ce82028bdd3e59ef322c93467028f670dd970cd6538e31e39","content_sha512":"7f4460188573fa722ea9a0d545b1f4f9bcec885c7f95e32963431eaf78c95c249ed34f9d65c7e05546e302855d62d7cbb5896f00e2c21d85c2601504e0c4e498","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/master-member.sh","id":"0470bf31d051ba14c247761e56d9fe6bb6f166c6","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"local_file","name":"prepare_kubeadm","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"#!/bin/sh\n\n# Rocky\n# Disble SELINUX \n# setenforce 0\n# sed -i --follow-symlinks 's/SELINUX=.*/SELINUX=disabled/g' /etc/sysconfig/selinux\n# #\n# dnf install -y dnf-utils\n# dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n# dnf install -y containerd.io socat conntrack iproute-tc iptables-ebtables iptables\n\n# Ubuntu fix using variables\n\nset -x\n#Add k8smaster IP\necho \"192.168.122.11    k8smaster\" \u003e\u003e /etc/hosts\n\n# Swap off\nswapoff -a                 \nsed -e '/swap/ s/^#*/#/' -i /etc/fstab  \n\necho \"Install containerd\"\ndpkg -i kubeadm/packages/containerd.io_1.6.33-1_amd64.deb\n\n\n# Config containerd\nmkdir -p /etc/containerd\ncp kubeadm/packages/config.toml /etc/containerd/\n\nmkdir -p /etc/nerdctl\ncp kubeadm/kubernetes/config/nerdctl.toml /etc/nerdctl/nerdctl.toml\n\nsystemctl restart containerd\n\n# Copy network binaries\ncp kubeadm/kubernetes/bin/* /usr/local/bin\n\n# Copy kubernetes binaries\ncp kubeadm/kubernetes/bin/v1.31.0/* /usr/local/bin\n\nchmod +x /usr/local/bin/*\ncp -R kubeadm/cni /opt\nchmod +x /opt/cni/bin/*\n\n# Load kubeadm container images\n#nerdctl load -i kubeadm/images/kubeadm.tar\n\n# Configure and start kubelet\ncp kubeadm/kubernetes/config/kubelet.service /etc/systemd/system\nmkdir -p /etc/systemd/system/kubelet.service.d\n\\cp -f kubeadm/kubernetes/config/kubelet.service.d/10-kubeadm.conf /etc/systemd/system/kubelet.service.d\n\nsystemctl daemon-reload\nsystemctl enable kubelet --now","content_base64":null,"content_base64sha256":"Pc2r3SQs5TBxYAH8XhzSb/KV1TVmIA/yTDNZnNqRx6U=","content_base64sha512":"5v0xUz/R4Ipcc4d/AayeaDS2VKblEbbBPZ8VJg/UMPu8dQQuLYHViUdhicyWCGJX63cKXdOl3TFo0tKVUoe3Dw==","content_md5":"d58b5fcb9bf54be058bb7d84244647c3","content_sha1":"139c7940c617138ee67720e87eade5fa5000c9f1","content_sha256":"3dcdabdd242ce530716001fc5e1cd26ff295d53566200ff24c33599cda91c7a5","content_sha512":"e6fd31533fd1e08a5c73877f01ac9e6834b654a6e511b6c13d9f15260fd430fbbc75042e2d81d589476189cc96086257eb770a5dd3a5dd3168d2d2955287b70f","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/prepare-kubeadm.sh","id":"139c7940c617138ee67720e87eade5fa5000c9f1","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]]}]},{"mode":"managed","type":"local_file","name":"worker","provider":"provider[\"registry.opentofu.org/hashicorp/local\"]","instances":[{"schema_version":0,"attributes":{"content":"# 01 init node\nmodprobe br_netfilter\necho 1 | sudo tee /proc/sys/net/ipv4/ip_forward\n\nchmod 400 $HOME/.ssh/id_rsa.key\n\n# Rocky linux \n#dnf install -y socat conntrack\n\nuntil [ $(ssh -i /root/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat join_cmd | wc -l) != 0 ];\ndo\n        echo \"Wait Master Node Init..\"\n\tsleep 10\ndone\n        ssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- kubeadm token create --print-join-command | sh -\n\nmkdir -p $HOME/.kube\nssh -i $HOME/.ssh/id_rsa.key -o StrictHostKeyChecking=no 192.168.122.11 -- cat /etc/kubernetes/admin.conf \u003e $HOME/.kube/config\nsed -i \"s/127\\.0\\.0\\.1/{master_ip}/g\" $HOME/.kube/config\n","content_base64":null,"content_base64sha256":"z8Rx7r30dkjJAlluzXIa7ngrsnE0rzKoDg4xE1jAYFk=","content_base64sha512":"QGUXSGj4lPmZYRSDpChyGVNb74D8W1uzKLJfPbvjXyN1qvrRJU9e31/xyQoBHr3oIDuoBt3kL0D2EA06g7nmXQ==","content_md5":"2cb66cf994918bb698e9a329935126e8","content_sha1":"2cfe4e0ef07aca83c51ba445e2f5f49107158dad","content_sha256":"cfc471eebdf47648c902596ecd721aee782bb27134af32a80e0e311358c06059","content_sha512":"4065174868f894f999611483a4287219535bef80fc5b5bb328b25f3dbbe35f2375aafad1254f5edf5ff1c90a011ebde8203ba806dde42f40f6100d3a83b9e65d","directory_permission":"0777","file_permission":"0777","filename":"./artifacts/kubeadm/scripts/worker.sh","id":"2cfe4e0ef07aca83c51ba445e2f5f49107158dad","sensitive_content":null,"source":null},"sensitive_attributes":[[{"type":"get_attr","value":"sensitive_content"}]],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm"]}]},{"mode":"managed","type":"terraform_data","name":"add_worker","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"node-02","schema_version":0,"attributes":{"id":"8ba2f737-beee-5b76-fdee-417f17c4e474","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker","terraform_data.copy_installer","terraform_data.init_master"]}]},{"mode":"managed","type":"terraform_data","name":"copy_installer","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"node-01","schema_version":0,"attributes":{"id":"4d80ad6e-7dcb-886a-aef3-be809043ef9d","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]},{"index_key":"node-02","schema_version":0,"attributes":{"id":"e652fd94-ba7b-ee92-d1bf-6e66375e6411","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker"]}]},{"mode":"managed","type":"terraform_data","name":"init_master","provider":"provider[\"terraform.io/builtin/terraform\"]","instances":[{"index_key":"node-01","schema_version":0,"attributes":{"id":"f4a212c2-1b9b-3864-8cc3-9dcb5c0b2bab","input":null,"output":null,"triggers_replace":null},"sensitive_attributes":[],"dependencies":["local_file.master_init","local_file.master_member","local_file.prepare_kubeadm","local_file.worker","terraform_data.copy_installer"]}]}],"check_results":null}
